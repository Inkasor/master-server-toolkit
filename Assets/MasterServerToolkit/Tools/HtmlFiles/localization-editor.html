        <!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Редактор локализации</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        input[type="text"] {
            width: 100%;
            box-sizing: border-box;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        input[type="text"]:focus {
            border-color: #4CAF50;
            outline: none;
            box-shadow: 0 0 5px rgba(76, 175, 80, 0.3);
        }
        
        h1, h2, h3 {
            color: #2c3e50;
        }
        
        button, input, select {
            padding: 8px 12px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        button {
            background-color: #4CAF50;
            color: white;
            cursor: pointer;
            border: none;
        }
        
        button:hover {
            background-color: #45a049;
        }
        
        table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 20px;
            background-color: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        
        tr:hover {
            background-color: #f5f5f5;
        }
        
        .category {
            background-color: #e9f7ef;
            font-weight: bold;
            padding: 15px;
            border-left: 5px solid #2ecc71;
            margin-top: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .category-name {
            display: flex;
            align-items: center;
            flex-grow: 1;
        }
        
        .category-name-text {
            cursor: pointer;
        }
        
        .category-name-input {
            margin-right: 10px;
            font-weight: bold;
            font-size: 16px;
            background-color: #f8f9fa;
        }
        
        .category-edit-buttons {
            margin-left: 10px;
        }
        
        #toggleAllButton {
            background-color: #9b59b6;
            margin-top: 10px;
        }
        
        #toggleAllButton:hover {
            background-color: #8e44ad;
        }
        
        .category-content {
            margin-left: 10px;
        }
        
        .category button {
            margin-left: 10px;
            font-size: 12px;
            padding: 5px 8px;
        }
        
        .controls {
            margin: 20px 0;
            padding: 15px;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .control-group {
            margin-bottom: 15px;
        }
        
        .lang-column {
            min-width: 200px;
        }
        
        .key-column {
            min-width: 180px;
        }
        
        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        
        .alert-success {
            background-color: #dff0d8;
            color: #3c763d;
        }
        
        .alert-error {
            background-color: #f2dede;
            color: #a94442;
        }
        
        #exportButton {
            background-color: #3498db;
        }
        
        #exportButton:hover {
            background-color: #2980b9;
        }
        
        .hidden {
            display: none;
        }
        
        .edit-buttons button {
            padding: 4px 8px;
            font-size: 12px;
        }
        
        .category-edit-form, .language-form, .entry-form {
            background-color: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
		
		.description {
            margin-bottom: 20px;
            color: #666;
            font-size: 16px;
            line-height: 1.5;
            max-width: 800px;
            background-color: #f9f9f9;
            padding: 15px;
            border-left: 3px solid #4CAF50;
            border-radius: 3px;
        }        
    </style>
</head>
<body>
    <h1>Master Server Toolkit</h1>
    <div class="description">
        Редактор локализации для управления многоязычными текстами. Позволяет создавать, редактировать и экспортировать языковые ключи, организованные по категориям. Поддерживает добавление новых языков и категорий.
    </div>
    
    <div id="notification" class="alert hidden"></div>
    
    <div class="controls">
        <div class="control-group">
            <h3>Загрузка файла локализации</h3>
            <input type="file" id="fileInput" accept=".csv">
            <button id="loadButton">Загрузить</button>
        </div>
        
        <div class="control-group">
            <h3>Управление</h3>
            <button id="addCategoryButton">Добавить категорию</button>
            <button id="addLanguageButton">Добавить язык</button>
            <button id="exportButton">Экспортировать CSV</button>
            <div id="exportInfo" style="display: none; margin-top: 5px; font-size: 12px; color: #666;">
                Сохраняет все категории, ключи и переводы в CSV-файл
            </div>
            <button id="toggleAllButton">Свернуть/Развернуть все</button>
        </div>
        
        <div id="categoryForm" class="category-edit-form hidden">
            <h3>Добавить новую категорию</h3>
            <input type="text" id="newCategoryName" placeholder="Название категории">
            <button id="saveCategoryButton">Сохранить</button>
            <button id="cancelCategoryButton">Отмена</button>
        </div>
        
        <div id="languageForm" class="language-form hidden">
            <h3>Добавить новый язык</h3>
            <input type="text" id="newLanguageCode" placeholder="Код языка (например, fr)">
            <button id="saveLanguageButton">Сохранить</button>
            <button id="cancelLanguageButton">Отмена</button>
        </div>
    </div>
    
    <div id="entryForm" class="entry-form hidden">
        <h3>Добавить новый элемент локализации</h3>
        <input type="text" id="newEntryKey" placeholder="Ключ элемента">
        <div id="entryLanguageInputs">
            <!-- Сюда будут добавлены поля ввода для каждого языка -->
        </div>
        <button id="saveEntryButton">Сохранить</button>
        <button id="cancelEntryButton">Отмена</button>
    </div>
    </div>
    
    <div id="categoryContainer"></div>
    
    <script>
        // Основная модель данных
        let localizationData = {
            categories: [],
            languages: ['ru', 'en', 'tr'], // По умолчанию языки из примера
            entries: {}
        };
        
        // DOM элементы
        const fileInput = document.getElementById('fileInput');
        const loadButton = document.getElementById('loadButton');
        const addCategoryButton = document.getElementById('addCategoryButton');
        const addLanguageButton = document.getElementById('addLanguageButton');
        const exportButton = document.getElementById('exportButton');
        const toggleAllButton = document.getElementById('toggleAllButton');
        const categoryContainer = document.getElementById('categoryContainer');
        const notification = document.getElementById('notification');
        
        // Формы
        const categoryForm = document.getElementById('categoryForm');
        const newCategoryName = document.getElementById('newCategoryName');
        const saveCategoryButton = document.getElementById('saveCategoryButton');
        const cancelCategoryButton = document.getElementById('cancelCategoryButton');
        
        const languageForm = document.getElementById('languageForm');
        const newLanguageCode = document.getElementById('newLanguageCode');
        const saveLanguageButton = document.getElementById('saveLanguageButton');
        const cancelLanguageButton = document.getElementById('cancelLanguageButton');
        
        const entryForm = document.getElementById('entryForm');
        const newEntryKey = document.getElementById('newEntryKey');
        const entryLanguageInputs = document.getElementById('entryLanguageInputs');
        const saveEntryButton = document.getElementById('saveEntryButton');
        const cancelEntryButton = document.getElementById('cancelEntryButton');
        
        // Переменная для хранения текущей категории при добавлении элемента
        let currentEditingCategory = null;
        
        // Функция для отображения уведомления
        function showNotification(message, isError = false) {
            notification.textContent = message;
            notification.className = isError ? 'alert alert-error' : 'alert alert-success';
            notification.classList.remove('hidden');
            setTimeout(() => {
                notification.classList.add('hidden');
            }, 3000);
        }
        
        // Функция загрузки файла
        loadButton.addEventListener('click', () => {
            const file = fileInput.files[0];
            if (!file) {
                showNotification('Выберите файл для загрузки', true);
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    parseCSV(event.target.result);
                    showNotification('Файл успешно загружен');
                } catch (error) {
                    showNotification('Ошибка при загрузке файла: ' + error.message, true);
                }
            };
            reader.readAsText(file);
        });
        
        // Функция для разбора CSV
        function parseCSV(csvContent) {
            // Разбиваем CSV на строки
            const lines = csvContent.split(/\r\n|\n/);
            
            // Извлекаем заголовки (коды языков)
            const headers = lines[0].split(';');
            
            // Первый столбец - ключи
            localizationData.languages = headers.slice(1);
            
            // Сбрасываем данные
            localizationData.categories = [];
            localizationData.entries = {};
            
            let currentCategory = null;
            
            // Перебираем строки, начиная со второй (после заголовков)
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue; // Пропускаем пустые строки
                
                const values = line.split(';');
                const key = values[0];
                
                // Проверяем, является ли строка категорией
                if (key.startsWith('#')) {
                    currentCategory = key.substring(2);
                    localizationData.categories.push(currentCategory);
                    localizationData.entries[currentCategory] = [];
                } else if (currentCategory && key) {
                    // Это обычная запись локализации
                    const entry = {
                        key: key,
                        values: {}
                    };
                    
                    // Заполняем значения для каждого языка
                    for (let j = 0; j < localizationData.languages.length; j++) {
                        const lang = localizationData.languages[j];
                        entry.values[lang] = values[j + 1] || '';
                    }
                    
                    localizationData.entries[currentCategory].push(entry);
                }
            }
            
            renderCategories();
        }
        
        // Функция рендеринга категорий и их содержимого
        function renderCategories() {
            categoryContainer.innerHTML = '';
            
            localizationData.categories.forEach(category => {
                const categoryElement = document.createElement('div');
                categoryElement.className = 'category';
                
                // Создаем элемент для отображения/редактирования имени категории
                const categoryNameElement = document.createElement('div');
                categoryNameElement.className = 'category-name';
                
                // Создаем текстовый элемент для отображения имени категории
                const categoryNameText = document.createElement('span');
                categoryNameText.textContent = category;
                categoryNameText.className = 'category-name-text';
                categoryNameElement.appendChild(categoryNameText);
                
                // Создаем поле ввода для редактирования (скрыто по умолчанию)
                const categoryNameInput = document.createElement('input');
                categoryNameInput.type = 'text';
                categoryNameInput.value = category;
                categoryNameInput.className = 'category-name-input hidden';
                categoryNameElement.appendChild(categoryNameInput);
                
                // Кнопки для сохранения/отмены редактирования (скрыты по умолчанию)
                const editButtonsContainer = document.createElement('div');
                editButtonsContainer.className = 'category-edit-buttons hidden';
                
                const saveEditButton = document.createElement('button');
                saveEditButton.textContent = 'Сохранить';
                saveEditButton.addEventListener('click', () => {
                    const newName = categoryNameInput.value.trim();
                    if (!newName) {
                        showNotification('Название категории не может быть пустым', true);
                        return;
                    }
                    
                    if (newName !== category && localizationData.categories.includes(newName)) {
                        showNotification(`Категория "${newName}" уже существует`, true);
                        return;
                    }
                    
                    if (newName !== category) {
                        renameCategory(category, newName);
                    } else {
                        // Выключаем режим редактирования, если название не изменилось
                        toggleCategoryEditMode(categoryElement, false);
                    }
                });
                
                const cancelEditButton = document.createElement('button');
                cancelEditButton.textContent = 'Отмена';
                cancelEditButton.addEventListener('click', () => {
                    categoryNameInput.value = category; // Сбрасываем значение
                    toggleCategoryEditMode(categoryElement, false);
                });
                
                editButtonsContainer.appendChild(saveEditButton);
                editButtonsContainer.appendChild(cancelEditButton);
                categoryNameElement.appendChild(editButtonsContainer);
                
                // Кнопки управления категорией
                const buttonsElement = document.createElement('div');
                buttonsElement.className = 'category-buttons';
                
                const toggleButton = document.createElement('button');
                toggleButton.textContent = 'Скрыть/Показать';
                toggleButton.className = 'toggle-category-btn';
                toggleButton.addEventListener('click', () => {
                    const content = categoryElement.nextElementSibling;
                    content.classList.toggle('hidden');
                });
                
                const renameButton = document.createElement('button');
                renameButton.textContent = 'Переименовать';
                renameButton.addEventListener('click', () => {
                    toggleCategoryEditMode(categoryElement, true);
                });
                
                const addEntryButton = document.createElement('button');
                addEntryButton.textContent = 'Добавить элемент';
                addEntryButton.addEventListener('click', () => {
                    showAddEntryForm(category);
                });
                
                buttonsElement.appendChild(toggleButton);
                buttonsElement.appendChild(renameButton);
                buttonsElement.appendChild(addEntryButton);
                
                categoryElement.appendChild(categoryNameElement);
                categoryElement.appendChild(buttonsElement);
                
                categoryContainer.appendChild(categoryElement);
                
                // Создаем содержимое категории
                const categoryContent = document.createElement('div');
                categoryContent.className = 'category-content';
                
                // Применяем состояние видимости на основе глобального состояния
                if (!allCategoriesExpanded) {
                    categoryContent.classList.add('hidden');
                }
                
                // Создаем таблицу для этой категории
                const table = document.createElement('table');
                
                // Создаем заголовок таблицы
                const thead = document.createElement('thead');
                const headerRow = document.createElement('tr');
                
                const keyHeader = document.createElement('th');
                keyHeader.textContent = 'Ключ';
                keyHeader.className = 'key-column';
                headerRow.appendChild(keyHeader);
                
                // Добавляем заголовки для каждого языка
                localizationData.languages.forEach(lang => {
                    const langHeader = document.createElement('th');
                    langHeader.textContent = lang;
                    langHeader.className = 'lang-column';
                    headerRow.appendChild(langHeader);
                });
                
                // Добавляем столбец для действий
                const actionsHeader = document.createElement('th');
                actionsHeader.textContent = 'Действия';
                headerRow.appendChild(actionsHeader);
                
                thead.appendChild(headerRow);
                table.appendChild(thead);
                
                // Создаем тело таблицы
                const tbody = document.createElement('tbody');
                
                // Добавляем строки для каждого элемента в категории
                if (localizationData.entries[category]) {
                    localizationData.entries[category].forEach(entry => {
                        const row = document.createElement('tr');
                        
                        // Ячейка с ключом (теперь редактируемая)
                        const keyCell = document.createElement('td');
                        const keyInput = document.createElement('input');
                        keyInput.type = 'text';
                        keyInput.value = entry.key;
                        keyInput.title = 'Нажмите для редактирования ключа';
                        keyInput.addEventListener('change', (e) => {
                            const newKey = e.target.value.trim();
                            if (!newKey) {
                                e.target.value = entry.key;
                                showNotification('Ключ не может быть пустым', true);
                                return;
                            }
                            
                            // Проверка на дублирование ключа
                            const keyExists = localizationData.entries[category].some(item => 
                                item !== entry && item.key === newKey
                            );
                            
                            if (keyExists) {
                                e.target.value = entry.key;
                                showNotification(`Ключ "${newKey}" уже существует в этой категории`, true);
                                return;
                            }
                            
                            entry.key = newKey;
                            showNotification(`Ключ изменен на "${newKey}"`);
                        });
                        keyCell.appendChild(keyInput);
                        row.appendChild(keyCell);
                        
                        // Ячейки для каждого языка
                        localizationData.languages.forEach(lang => {
                            const langCell = document.createElement('td');
                            const input = document.createElement('input');
                            input.type = 'text';
                            input.value = entry.values[lang] || '';
                            input.addEventListener('change', (e) => {
                                entry.values[lang] = e.target.value;
                            });
                            langCell.appendChild(input);
                            row.appendChild(langCell);
                        });
                        
                        // Ячейка с действиями
                        const actionsCell = document.createElement('td');
                        actionsCell.className = 'edit-buttons';
                        
                        const deleteButton = document.createElement('button');
                        deleteButton.textContent = 'Удалить';
                        deleteButton.addEventListener('click', () => {
                            deleteEntry(category, entry.key);
                        });
                        
                        actionsCell.appendChild(deleteButton);
                        row.appendChild(actionsCell);
                        
                        tbody.appendChild(row);
                    });
                }
                
                table.appendChild(tbody);
                categoryContent.appendChild(table);
                categoryContainer.appendChild(categoryContent);
            });
        }
        
        // Функция переименования категории
        function renameCategory(oldName, newName) {
            const index = localizationData.categories.indexOf(oldName);
            if (index !== -1) {
                localizationData.categories[index] = newName;
                localizationData.entries[newName] = localizationData.entries[oldName];
                delete localizationData.entries[oldName];
                renderCategories();
                showNotification(`Категория "${oldName}" переименована в "${newName}"`);
            }
        }
        
        // Функция переключения режима редактирования для категории
        function toggleCategoryEditMode(categoryElement, enable) {
            const nameText = categoryElement.querySelector('.category-name-text');
            const nameInput = categoryElement.querySelector('.category-name-input');
            const editButtons = categoryElement.querySelector('.category-edit-buttons');
            
            if (enable) {
                nameText.classList.add('hidden');
                nameInput.classList.remove('hidden');
                editButtons.classList.remove('hidden');
                nameInput.focus();
                nameInput.select();
            } else {
                nameText.classList.remove('hidden');
                nameInput.classList.add('hidden');
                editButtons.classList.add('hidden');
            }
        }
        
        // Функция отображения формы для добавления нового элемента
        function showAddEntryForm(category) {
            // Сохраняем текущую категорию
            currentEditingCategory = category;
            
            // Очищаем поле ключа
            newEntryKey.value = '';
            
            // Очищаем и создаем поля ввода для каждого языка
            entryLanguageInputs.innerHTML = '';
            
            // Создаем заголовок для языковых полей
            const languagesHeader = document.createElement('div');
            languagesHeader.className = 'languages-header';
            languagesHeader.style.marginTop = '15px';
            languagesHeader.style.marginBottom = '5px';
            languagesHeader.style.fontWeight = 'bold';
            languagesHeader.textContent = 'Значения для каждого языка:';
            entryLanguageInputs.appendChild(languagesHeader);
            
            // Добавляем поля ввода для каждого языка
            localizationData.languages.forEach(lang => {
                const langContainer = document.createElement('div');
                langContainer.className = 'language-input-container';
                langContainer.style.marginBottom = '10px';
                
                const langLabel = document.createElement('label');
                langLabel.textContent = lang + ':';
                langLabel.style.display = 'inline-block';
                langLabel.style.width = '50px';
                langLabel.style.marginRight = '10px';
                
                const langInput = document.createElement('input');
                langInput.type = 'text';
                langInput.className = 'lang-input';
                langInput.dataset.lang = lang;
                langInput.placeholder = `Перевод для ${lang}`;
                
                langContainer.appendChild(langLabel);
                langContainer.appendChild(langInput);
                entryLanguageInputs.appendChild(langContainer);
            });
            
            // Находим родительский элемент категории и добавляем форму после него
            const categoryElements = document.querySelectorAll('.category');
            let categoryElement = null;
            
            for (let i = 0; i < categoryElements.length; i++) {
                const nameElement = categoryElements[i].querySelector('.category-name-text');
                if (nameElement && nameElement.textContent === category) {
                    categoryElement = categoryElements[i];
                    break;
                }
            }
            
            if (categoryElement) {
                // Размещаем форму после содержимого категории
                const categoryContent = categoryElement.nextElementSibling;
                entryForm.style.display = 'block';
                categoryContent.appendChild(entryForm);
                newEntryKey.focus();
            } else {
                // Если не нашли элемент категории, показываем форму в конце контейнера
                entryForm.classList.remove('hidden');
                categoryContainer.appendChild(entryForm);
            }
        }
        
        // Функция сохранения нового элемента
        function saveNewEntry() {
            const category = currentEditingCategory;
            const key = newEntryKey.value.trim();
            
            if (!key) {
                showNotification('Введите ключ для нового элемента', true);
                return false;
            }
            
            if (!localizationData.entries[category]) {
                localizationData.entries[category] = [];
            }
            
            // Проверка на дублирование ключа
            const exists = localizationData.entries[category].some(entry => entry.key === key);
            if (exists) {
                showNotification(`Ключ "${key}" уже существует в категории "${category}"`, true);
                return false;
            }
            
            // Создаем новый элемент
            const newEntry = {
                key: key,
                values: {}
            };
            
            // Собираем значения для всех языков из формы
            const langInputs = entryForm.querySelectorAll('.lang-input');
            langInputs.forEach(input => {
                const lang = input.dataset.lang;
                newEntry.values[lang] = input.value;
            });
            
            // Добавляем элемент в категорию
            localizationData.entries[category].push(newEntry);
            
            // Скрываем форму и обновляем отображение
            entryForm.classList.add('hidden');
            entryForm.style.display = 'none';
            document.body.appendChild(entryForm); // Перемещаем форму обратно в body
            
            renderCategories();
            showNotification(`Добавлен новый элемент "${key}" в категорию "${category}"`);
            return true;
        }
        
        // Функция удаления элемента
        function deleteEntry(category, key) {
            if (confirm(`Вы уверены, что хотите удалить элемент "${key}"?`)) {
                const index = localizationData.entries[category].findIndex(entry => entry.key === key);
                if (index !== -1) {
                    localizationData.entries[category].splice(index, 1);
                    renderCategories();
                    showNotification(`Элемент "${key}" удален из категории "${category}"`);
                }
            }
        }
        
        // Обработчики для формы категории
        addCategoryButton.addEventListener('click', () => {
            categoryForm.classList.remove('hidden');
            languageForm.classList.add('hidden');
            newCategoryName.value = '';
            newCategoryName.focus();
        });
        
        saveCategoryButton.addEventListener('click', () => {
            const name = newCategoryName.value.trim();
            if (!name) {
                showNotification('Введите название категории', true);
                return;
            }
            
            if (localizationData.categories.includes(name)) {
                showNotification(`Категория "${name}" уже существует`, true);
                return;
            }
            
            localizationData.categories.push(name);
            localizationData.entries[name] = [];
            categoryForm.classList.add('hidden');
            renderCategories();
            showNotification(`Добавлена новая категория "${name}"`);
        });
        
        cancelCategoryButton.addEventListener('click', () => {
            categoryForm.classList.add('hidden');
        });
        
        // Обработчики для формы языка
        addLanguageButton.addEventListener('click', () => {
            languageForm.classList.remove('hidden');
            categoryForm.classList.add('hidden');
            newLanguageCode.value = '';
            newLanguageCode.focus();
        });
        
        saveLanguageButton.addEventListener('click', () => {
            const code = newLanguageCode.value.trim();
            if (!code) {
                showNotification('Введите код языка', true);
                return;
            }
            
            if (localizationData.languages.includes(code)) {
                showNotification(`Язык "${code}" уже существует`, true);
                return;
            }
            
            localizationData.languages.push(code);
            
            // Добавляем пустое значение для нового языка во все существующие элементы
            Object.keys(localizationData.entries).forEach(category => {
                localizationData.entries[category].forEach(entry => {
                    entry.values[code] = '';
                });
            });
            
            languageForm.classList.add('hidden');
            renderCategories();
            showNotification(`Добавлен новый язык "${code}"`);
        });
        
        cancelLanguageButton.addEventListener('click', () => {
            languageForm.classList.add('hidden');
        });
        
        // Обработчики для формы добавления элемента
        saveEntryButton.addEventListener('click', () => {
            if (saveNewEntry()) {
                currentEditingCategory = null;
            }
        });
        
        cancelEntryButton.addEventListener('click', () => {
            entryForm.classList.add('hidden');
            entryForm.style.display = 'none';
            document.body.appendChild(entryForm); // Перемещаем форму обратно в body
            currentEditingCategory = null;
        });
        
        // Функция экспорта в CSV
        exportButton.addEventListener('click', () => {
            try {
                // Генерируем содержимое CSV-файла
                const csvContent = generateCSV();
                
                // Создаем имя файла с датой для уникальности
                const date = new Date();
                const formattedDate = date.toISOString().slice(0, 10).replace(/-/g, '');
                const fileName = `localization_${formattedDate}.csv`;
                
                // Вызываем функцию скачивания
                downloadCSV(csvContent, fileName);
                
                // Показываем уведомление об успехе
                showNotification(`Файл ${fileName} успешно экспортирован`);
            } catch (error) {
                // В случае ошибки показываем уведомление
                showNotification('Ошибка при экспорте файла: ' + error.message, true);
                console.error('Ошибка при экспорте:', error);
            }
        });
        
        // Функция генерации CSV
        function generateCSV() {
            try {
                // Формируем заголовок
                let csvContent = 'keys;' + localizationData.languages.join(';') + '\r\n';
                
                // Добавляем пустую строку после заголовка
                csvContent += ';' + ';'.repeat(localizationData.languages.length) + '\r\n';
                
                // Добавляем данные по категориям
                localizationData.categories.forEach(category => {
                    // Добавляем строку категории
                    csvContent += '# ' + category + ';' + ';'.repeat(localizationData.languages.length) + '\r\n';
                    
                    // Добавляем элементы категории
                    if (localizationData.entries[category]) {
                        localizationData.entries[category].forEach(entry => {
                            // Добавляем ключ с обработкой специальных символов
                            const safeKey = escapeCSVField(entry.key);
                            csvContent += safeKey;
                            
                            // Добавляем значения для каждого языка с обработкой специальных символов
                            localizationData.languages.forEach(lang => {
                                const value = entry.values[lang] || '';
                                const safeValue = escapeCSVField(value);
                                csvContent += ';' + safeValue;
                            });
                            
                            csvContent += '\r\n';
                        });
                    }
                    
                    // Добавляем пустую строку после категории
                    csvContent += ';' + ';'.repeat(localizationData.languages.length) + '\r\n';
                });
                
                return csvContent;
            } catch (error) {
                console.error('Ошибка при генерации CSV:', error);
                throw new Error('Не удалось сгенерировать CSV: ' + error.message);
            }
        }
        
        // Функция для обработки специальных символов в CSV полях
        function escapeCSVField(field) {
            // Если поле содержит ; " или перенос строки, оборачиваем его в кавычки
            if (field && (field.includes(';') || field.includes('"') || field.includes('\n') || field.includes('\r'))) {
                // Заменяем " на ""
                return '"' + field.replace(/"/g, '""') + '"';
            }
            return field;
        }
        
        // Функция для скачивания CSV
        function downloadCSV(csvContent, filename) {
            // Добавляем BOM (Byte Order Mark) для корректного отображения кириллицы в Excel
            const BOM = "\uFEFF";
            const csvContentWithBOM = BOM + csvContent;
            
            // Создаем Blob с правильной кодировкой
            const blob = new Blob([csvContentWithBOM], { 
                type: 'text/csv;charset=utf-8;' 
            });
            
            // Создаем URL для скачивания
            const url = URL.createObjectURL(blob);
            
            // Создаем элемент "a" для инициирования скачивания
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            
            // Добавляем ссылку на страницу, инициируем скачивание и удаляем
            document.body.appendChild(link);
            link.click();
            
            // Небольшая задержка перед удалением ссылки
            setTimeout(() => {
                document.body.removeChild(link);
                URL.revokeObjectURL(url); // Освобождаем ресурс
            }, 100);
        }
        
        // Флаг состояния для всех категорий (true = развернуты, false = свернуты)
        let allCategoriesExpanded = true;
        
        // Функция для сворачивания/разворачивания всех категорий
        function toggleAllCategories() {
            const categoryContents = document.querySelectorAll('.category-content');
            
            categoryContents.forEach(content => {
                if (allCategoriesExpanded) {
                    content.classList.add('hidden');
                } else {
                    content.classList.remove('hidden');
                }
            });
            
            // Меняем состояние
            allCategoriesExpanded = !allCategoriesExpanded;
            
            // Обновляем текст кнопки
            toggleAllButton.textContent = allCategoriesExpanded ? 'Свернуть все' : 'Развернуть все';
            
            // Показываем уведомление
            showNotification(allCategoriesExpanded ? 'Все категории развернуты' : 'Все категории свернуты');
        }
        
        // Обработчик кнопки сворачивания/разворачивания всех категорий
        toggleAllButton.addEventListener('click', toggleAllCategories);
        
        // Инициализация с тестовыми данными
        initializeWithTestData();
        
        function initializeWithTestData() {
            // Создаем одну тестовую категорию с парой ключей
            localizationData.categories = ['Common'];
            localizationData.languages = ['ru', 'en', 'tr'];
            
            localizationData.entries = {
                'Common': [
                    {
                        key: 'welcome',
                        values: {
                            'ru': 'Добро пожаловать',
                            'en': 'Welcome',
                            'tr': 'Hoş geldiniz'
                        }
                    },
                    {
                        key: 'save',
                        values: {
                            'ru': 'Сохранить',
                            'en': 'Save',
                            'tr': 'Kaydet'
                        }
                    }
                ]
            };
            
            // Устанавливаем начальное состояние кнопки сворачивания/разворачивания
            allCategoriesExpanded = true;
            toggleAllButton.textContent = 'Свернуть все';
            
            renderCategories();
        }
    </script>
</body>
</html>