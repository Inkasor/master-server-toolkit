# Master Server Toolkit - Ядро системы

## Общий обзор
Ядро Master Server Toolkit состоит из базовых компонентов, которые обеспечивают фундаментальную функциональность для построения многопользовательских игр. Эти компоненты тесно взаимодействуют между собой, создавая гибкую и расширяемую архитектуру.

## Структура ядра

### [MasterServer](MasterServer.md)
Центральный компонент, предоставляющий доступ ко всем системам через класс `Mst`. Содержит основные настройки и конфигурацию сервера.

### [Client](Client.md)
Клиентская часть системы для подключения к серверу, отправки запросов и обработки ответов. Включает базовый класс для клиентских модулей.

### [Server](Server.md)
Серверная часть системы для обработки подключений, регистрации обработчиков сообщений и управления модулями.

### [Database](Database.md)
Абстракция для работы с различными базами данных. Позволяет использовать разные хранилища данных без изменения основного кода.

### [Events](Events.md)
Система событий для обмена сообщениями между компонентами без жестких зависимостей. Основа для слабосвязанной архитектуры.

### [Keys](Keys.md)
Система констант и ключей для унификации доступа к данным. Предотвращает ошибки из-за опечаток при работе со строковыми идентификаторами.

### [Localization](Localization.md)
Система локализации для поддержки множества языков. Позволяет легко добавлять и менять переводы.

### [Logger](Logger.md)
Система логирования для отслеживания работы приложения. Поддерживает различные уровни логирования и форматирование.

### [Mail](Mail.md)
Система для отправки email сообщений. Используется для подтверждения регистрации, восстановления пароля и других целей.

## Взаимодействие компонентов

![Архитектура ядра](../Images/core_architecture.png)

### Основные взаимосвязи:

1. **MasterServer** содержит центральный класс `Mst`, который предоставляет доступ ко всем другим компонентам:
   ```csharp
   // Доступ к клиенту
   Mst.Client
   
   // Доступ к серверу
   Mst.Server
   
   // Доступ к системе событий
   Mst.Events
   ```

2. **Client и Server** используют общую систему сетевых сообщений, но работают на разных сторонах соединения:
   ```csharp
   // На стороне клиента
   Mst.Client.Connection.SendMessage(MstOpCodes.SignIn, credentials);
   
   // На стороне сервера
   server.RegisterMessageHandler(MstOpCodes.SignIn, HandleSignIn);
   ```

3. **Database** используется серверными модулями для доступа к данным:
   ```csharp
   // Получение аксессора базы данных
   var dbAccessor = Mst.Server.DbAccessors.GetAccessor<IAccountsDatabaseAccessor>();
   
   // Использование аксессора
   var account = await dbAccessor.GetAccountByUsername(username);
   ```

4. **Events** используется всеми компонентами для слабосвязанного обмена информацией:
   ```csharp
   // Отправка события
   Mst.Events.Invoke("userLoggedIn", userId);
   
   // Подписка на событие
   Mst.Events.AddListener("userLoggedIn", OnUserLoggedIn);
   ```

5. **Logger** используется повсеместно для отладки и мониторинга:
   ```csharp
   // Логирование событий
   Mst.Logger.Debug("Connection established");
   Mst.Logger.Error($"Failed to connect: {error}");
   ```

6. **Keys** используется для стандартизации доступа к данным:
   ```csharp
   // Использование ключей
   properties.Set(MstDictKeys.USER_ID, userId);
   properties.Set(MstDictKeys.USER_NAME, username);
   ```

7. **Localization** обеспечивает мультиязычность:
   ```csharp
   // Получение локализованной строки
   string welcomeText = Mst.Localization.GetString("welcome_message");
   ```

8. **Mail** используется серверными модулями для коммуникации с пользователями:
   ```csharp
   // Отправка письма
   await Mst.Server.Mail.SendEmailAsync(email, subject, body);
   ```

## Процесс инициализации

1. Создание экземпляра `MasterServerBehaviour`
2. Определение настроек подключения (IP, порт, безопасность)
3. Регистрация необходимых модулей
4. Запуск сервера или подключение клиента
5. Инициализация всех зарегистрированных модулей
6. Установка необходимых обработчиков сообщений

## Принципы построения модулей

Ядро предоставляет базовые классы для создания модулей:
- `BaseServerModule` - Для серверных модулей
- `BaseClientModule` - Для клиентских модулей

Модули следуют следующим принципам:
1. **Единственная ответственность** - Каждый модуль отвечает за одну функциональность
2. **Слабая связность** - Общение через события и общий интерфейс
3. **Расширяемость** - Возможность наследования и переопределения базового поведения
4. **Зависимость от абстракций** - Использование интерфейсов вместо конкретных реализаций

## Рекомендации по работе с ядром

1. **Используйте события** вместо прямых вызовов для уменьшения связности
2. **Инкапсулируйте логику** в специализированные модули
3. **Следуйте архитектуре** базовых компонентов при создании своих
4. **Используйте базовые классы** вместо создания с нуля
5. **Документируйте интерфейсы** для облегчения дальнейшего сопровождения
